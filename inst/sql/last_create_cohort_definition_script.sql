-- Creates the cohorts to be used in SVVEHDEN-sprint, according to updated study protocol.

/* Input variables (sent from cohort-module) */
-- These local variables are "rendered" by the R-script before execution.
-- the concept id for the target drug of interest - T
-- the concept ids for comparator drugs (any other drug than the target drug in the database) - C
-- concept ids for the event, i.e. outcome of interest - O
-- the schema that will hold all cohorts
-- the table name where the final cohort tables will reside
-- the schema where the OMOP data is located
-- a limitation on the cohort size (NUMBER OF EXPECTED NUMBER OF EVENTS?)

/* 
##################################################################################
Chronograph analyses:
IC = log2 ((N_observed + 0.5)/(N_expected + 0.5))
where N_expected = (Ntarget_drug * N_event) / Ntotal

N_expected: expected number of subjects with the target drug-event combination (i.e. derived from 22, 32 and 42) 
N_observed: actual number of subjects with the target drug-event combination (i.e. intersection of 22 and 32)
N_target_drug: number of subjects with the target drug (i.e. target drug cohort (22))
N_event: total number of subjects with the event in target and comparator drug cohort combined (32)
N_total: total number of subjects in target and comparator drug cohort combined (i.e. total drug cohort, (42))
##################################################################################
For convenience, the cohorts are enumerated as follows (cohort IDs):  
11(0):  Target drug cohort with event in 30-day post-index risk window (descriptive analyses)
21(0):  Target drug cohort (descriptive analyses)
22(0):  Target drug cohort (chronograph analyses)
31(0):  Comparator drug cohort with event in 30-day post-index risk window (descriptive analyses)
32(0):  Total drug (target and comparator) cohort with event(s) in 3-yrs pre and/or post-index risk window (chronograph analyses) (i.e. derived from 42 and 3)
40(0)*: Comparator drug cohort (chronograph analyses)
41(0):  Comparator drug cohort (descriptive analyses)
42(0):  Total drug (target and comparator) cohort (chronograph analyses) (i.e. derived from 22 and 40)
2*:     Study pool of eligible target drug eras used for defining first and randomly sampled target drug era cohorts  
3*:     Study pool of eligible condition eras
4*:     Study pool of eligible comparator drug eras used for defining first and randomly sampled comparator drug era cohorts 
############################################
-- Cohorts 11, 21, 31 and 41 serve as input for descriptive tables (risk window: max. 30-day post index date)
-- Cohorts 22, 32 and 42 serve as input for chronograph analyses (risk window: max. 3-yrs pre and max 3-yrs post index date)
-- Each subject is observed only once in the target drug (21, 22) and comparator drug (41, 42) cohorts
-- Each subject has at least 13-months pre and 1-day post-index observation time (equals time window of drug persistence gap)
-- Each subject contributes max 1 event to descriptive analyses 
-- Each subject can contribute more than 1 event to chronograph analyses 
-- By default, all cohort IDs refer to drug exposure defined based on first-time use (i.e. first drug era)
-- NOTE: Cohort IDs with "0" extension refer to drug exposure defined based on a randomly sampled drug era - TO BE ADDED IF NEEDED
-- NOTE: Study pool of eligible drug eras (2* and 4*) serve as input for defining first and randomly sampled (target/comparator) drug eras 
-- NOTE: Study pool of eligible condition eras (3*) for extraction of event occurences for descriptive analyses (i.e. first post-index event) and chronograph analyses (any event within pre- and postindex risk window)  
-- NOTE: Cohort 40 is currently not used as input for chronograph analyses, but will serve as input in matched cohort design
-- NOTE: set SEED to make sampling reproducible (RAND(SEED) FUNCTION)
############################################
*/

/*Input variables (sent from cohort-module)*/
-- These local variables are "rendered" by the R-script before execution.
-- the concept id for the drug of interest
-- the concept ids for comparator drugs (typically all drugs in the database)
-- concept ids for the outcome/event ID
-- the schema that will hold all cohorts
-- the table name where the final cohort tables will reside
-- the schema where the OMOP data is located
-- a limitation on the cohort size

---------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------

/* CREATE TABLE WITH EMPTY KEY VARIABLES */
-- Initiate one table with suffix original, where all cohort data will be inserted before processing/sampling 
IF OBJECT_ID('OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original', 'U') IS NOT NULL
DROP TABLE OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original;
CREATE TABLE OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original (
  cohort_definition_id INT,                           --unique identifier for each cohort
  cohort_start_date DATE,
  cohort_end_date DATE,
  subject_id BIGINT,
  drug_concept_id INT, -- not needed in final table, used for sampling 
  drug_era_start_date DATE, -- not needed in final table, used for setting risk time 
  drug_era_end_date DATE, -- not needed in final table, used for setting risk time 
  observation_period_start_date DATE, -- not needed in final table, used for setting risk time 
  observation_period_end_date DATE, -- not needed in final table, used for setting risk time 
  death_date DATE, -- not needed in final table, used for checking data 
  order_number INT, -- not needed in final table, identifier for first time use
  row_number INT -- not needed in final table, used for sampling 
  );

---------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------

/* COHORT 2*. POPULATE TABLE WITH COHORT OF ELIGIBLE TARGET DRUG ERAS (STUDY POOL)*/
-- Study pool for constructing target drug cohorts based on first era (21, 22) or randomly sampled era (210, 220) 
-- Includes drug eras with at least 13-months pre and 1-day post drug start database observation 
-- NOTE: to be added: code for extracting distinct drug eras based on predefined drug era gap, 13 months (required for randomly sampled drug era cohorts)
INSERT INTO OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original (
  cohort_definition_id,
  subject_id,
  drug_concept_id,
  drug_era_start_date,
  drug_era_end_date,
  observation_period_start_date,
  observation_period_end_date,
  death_date
)
SELECT 2 AS cohort_definition_id, 
       x.person_id AS subject_id,
       x.drug_concept_id,
       x.drug_era_start_date, 
       x.drug_era_end_date,
       y.observation_period_start_date,
       y.observation_period_end_date,
       z.death_date
FROM OmopCdm.synpuf5pct_20180710.drug_era x
LEFT JOIN OmopCdm.synpuf5pct_20180710.death z						--add death_date to table (used for checking data only)
	  ON x.person_id = z.person_id
INNER JOIN OmopCdm.synpuf5pct_20180710.observation_period y	        --add observation_period_start_date and observation_period_end_date to table (needed for setting risk time)
      ON x.person_id = y.person_id
	   AND y.observation_period_start_date < x.drug_era_start_date
	   AND y.observation_period_end_date > x.drug_era_start_date
WHERE (DATEDIFF(MONTH, y.observation_period_start_date, x.drug_era_start_date) >= 13) AND (x.drug_concept_id IN (914533));  --select drug eras with at least 13-months pre and 1-day post-index observation time

 ---------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------

/* COHORT 21. POPULATE TABLE WITH TARGET DRUG COHORT BASED ON FIRST TIME USE (FOR DESCRIPTIVE ANALYSES) */
-- Cohort constructed using COHORT 2 (pool of eligible target drug eras) as study base 
-- Risk time starts at drug_era_start_date (i.e. index date)
-- Risk time ends at drug_era_start_date+30 days or last date of observation (includes death) whichever occurs first 
-- Note: no need to define censoring based on drug_era_end_date as max time at risk is 30 days
INSERT INTO OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original (
  cohort_definition_id,
  cohort_start_date,
  cohort_end_date,
  subject_id,
  drug_concept_id,
  drug_era_start_date,
  observation_period_end_date,
  death_date,
  order_number)
SELECT 21 AS cohort_definition_id, 
       t.drug_era_start_date AS cohort_start_date,							-- set cohort start date (index date) as drug era start date
	   CASE WHEN t.observation_period_end_date <= DATEADD(DAY, +30, t.drug_era_start_date)	-- set cohort end date as last day of obs or drug er start date +30 days whichever occurs first
			THEN t.observation_period_end_date 
			ELSE DATEADD(DAY, +30, t.drug_era_start_date)  
			END AS cohort_end_date,
       t.subject_id,
       t.drug_concept_id,
       t.drug_era_start_date,
       t.observation_period_end_date,
       t.death_date,
       t.order_number
FROM ( SELECT subject_id,											
              drug_concept_id,
              drug_era_start_date,
              observation_period_end_date,
              death_date,
              ROW_NUMBER() OVER ( PARTITION BY subject_id													-- select first-time use of target drug only (i.e. first drug era)
                                  ORDER by drug_era_start_date
                                ) AS order_number 
       FROM OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original
       WHERE cohort_definition_id = 2) t 
WHERE t.order_number = 1;

---------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------

/* COHORT 22. POPULATE TABLE WITH TARGET DRUG COHORT BASED ON FIRST TIME USE (FOR CHRONOGRAPH ANALYSES) */
-- Risk time starts at drug_era_start_date-3 yrs or earliest date of observation whichever occurs last
-- Risk time ends at drug_era_start_date+3 yrs, drug era end date or last date of observation (includes death) whichever occurs first 
-- Note: need to set persistence gap for drug eras (default is ?)
INSERT INTO OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original (
  cohort_definition_id,
  cohort_start_date,
  cohort_end_date,
  subject_id,
  drug_concept_id,
  drug_era_start_date,
  observation_period_end_date,
  death_date,
  order_number)
SELECT 22 AS cohort_definition_id, 
       t.drug_era_start_date AS cohort_start_date,							-- set cohort start date (index date) as drug era start date
	   t.drug_era_end_date AS cohort_end_date,
       t.subject_id,
       t.drug_concept_id,
       t.drug_era_start_date,
       t.observation_period_end_date,
       t.death_date,
       t.order_number
FROM ( SELECT subject_id,											
              drug_concept_id,
              drug_era_start_date,
			  drug_era_end_date,
              observation_period_end_date,
              death_date,
              ROW_NUMBER() OVER ( PARTITION BY subject_id													-- select first-time use of target drug only (i.e. first drug era)
                                  ORDER by drug_era_start_date
                                ) AS order_number 
       FROM OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original
       WHERE cohort_definition_id = 2) t 
WHERE t.order_number = 1;

---------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------

/* COHORT 4*. POPULATE TABLE WITH COHORT OF ELIGIBLE COMPARATOR DRUG ERAS (STUDY POOL)*/
-- Study pool for constructing comparator drug cohorts based on first era (41, 42) or randomly sampled era (410, 420)
-- Randomly samples 1 comparator drug per subject
-- NOTE: to be added: code for extracting distinct drug eras based on predefined drug era gap, 13 months (required for randomly sampled drug era cohorts)
INSERT INTO OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original (
  cohort_definition_id,
  subject_id,
  drug_concept_id,
  drug_era_start_date,
  drug_era_end_date,
  observation_period_start_date,
  observation_period_end_date,
  death_date
)
SELECT 4 AS cohort_definition_id, 
       person_id,
	   drug_concept_id,
	   drug_era_start_date, 
	   drug_era_end_date,
	   observation_period_start_date,
	   observation_period_end_date,
	   death_date
FROM ( SELECT *, 
              Row_number() OVER(PARTITION BY person_id ORDER BY newid()) AS one_row_per_person_row_number -- Scramble the order
       FROM ( SELECT x.person_id, 
		             x.drug_concept_id, 
					 x.drug_era_start_date, 
                     x.drug_era_end_date,
					 y.observation_period_start_date, 
					 y.observation_period_end_date, 
					 z.death_date,
                     Row_number() OVER(PARTITION BY x.person_id, drug_concept_id ORDER BY newid()) AS one_row_per_person_and_drug_row_number -- Scramble the order
              FROM  OmopCdm.synpuf5pct_20180710.drug_era x
	          LEFT JOIN OmopCdm.synpuf5pct_20180710.death z						--add death_date to table (used for checking data only)
	                       ON x.person_id = z.person_id
	          INNER JOIN OmopCdm.synpuf5pct_20180710.observation_period y			--add observation_period_start_date and observation_period_end_date to table (needed for setting risk time)
                           ON x.person_id = y.person_id
	                       AND y.observation_period_start_date < x.drug_era_start_date
	                       AND y.observation_period_end_date > x.drug_era_start_date
	          WHERE (DATEDIFF(MONTH, y.observation_period_start_date, x.drug_era_start_date) >= 13)  --select drug eras with at least 13-months pre and 1-day post-index observation time 
				    AND drug_concept_id IN (19000498,906914,40161256,529176,43012293,1331235,40161949,1551673,1322207,966376,19004969,40171275,722031,40175955,1730370,1119119,1776430,40172543,40171641,40170582,1400959,19090244,1308473,1337651,40172352,40161154,1337860,714684,910888,19003999,952004,19089810,950098,594249,40167672,40174015,544411,40161758,1518254,45892419,1133993,40175853,532881,40221981,1000995,532452,19095690,1036636,19010360,1507558,1341238,900017,40174517,1789521,19012925,40161115,1539403,40161813,947651,836654,1715117,19086759,19051463,988095,1103518,738152,40167029,917006,905233,742594,1201620,509081,40171105,1103552,40172250,1307542,1541079,1549686,1333379,1367268,989567,19060423,1192710,918172,40171965,40161583,924724,1308290,1036228,19004153,40162255,715233,40174020,40175806,1158632,1502826,40172684,19054825,19024191,968426,907879,19058420,1401581,19036892,751698,1735947,1761033,1769389,40162001,19097209,1341149,40162187,40173620,19112635,40172266,40161669,19088035,40170543,904250,19092712,1381661,909165,40170475,781182,19090171,40171594,1710612,40172530,948856,40172198,19052736,19095269,930021,1189766,1124957,40161052,1510813,1143374,1391889,918222,759740,1136422,987245,906072,40172365,1340532,1517998,916282,1771162,40170862,40161316,40227367,40163706,40174420,1388796,990678,741530,1377023,1114771,40171939,1319880,40227359,1750928,40224734,40162247,19059547,40170854,19044273,40173207,19052059,1717002,740560,529116,19069022,19010496,40161528,40163698,700299,19024068,937368,40175764,528295,40226721,19038440,915542,19008339,943852,523283,19088393,1334456,19041065,1781314,586306,40172441,544505,1708748,19078097,725822,19060985,40170786,40172590,19018384,19090984,1395573,1123995,740275,989878,42801309,1503184,1311443,997881,40171288,1036487,19058896,19022494,950370,1704183,40169416,1589505,1748975,953076,994341,40170650,928110,1713930,1125765,905531,795661,711714,19042801,715458,19097468,1311409,19012585,40172305,40175900,19067971,1318011,40222444,42800778,936429,797617,40174229,1103006,40172606,40172457,40224216,19008893,19017581,1305058,752061,19080406,1195492,916460,752276,1511856,1401437,909021,1798476,40172206,1308368,40161910,1592180,969004,532274,19136207,19078649,40171957,1319998,781705,43014126,19011565,40170483,40175801,19005147,990009,1150770,1150836,40175916,1383925,1311276,964407,1354860,1728903,40161776,1325363,40172321,1125449,40226622,19051926,734275,780369,955583,19086788,710062,40163682,19033778,1436169,1395557,1130863,40226671,1304107,1776684,916943,948582,715727,40175665,912263,1037358,1563600,19066188,19005570,1315140,40172778,1777254,717136,1360332,19021932,751889,40226208,19027362,40175686,40163661,40161789,40162132,751246,1189596,798874,532460,1192218,919681,40162239,988294,19044317,1153664,1362225,1197677,1322199,40225722,19136187,778711,40167348,718122,40170420,1727468,40161646,40230159,19087394,1391648,1328165,19094153,40172135,514012,907013,1501309,1391248,19030120,1133201,1335539,1763779,1741008,916230,19029370,1715472,40166605,40161146,40164833,1304044,1774932,19004098,1135766,1387104,19099183,1553610,35605594,1310353,1550023,40172485,40170470,1336825,19099126,19082850,40170370,19017895,1337068,1505346,40175843,523202,756349,19035577,1379525,1542948,19097463,710650,1196514,40174023,901656,967861,19086560,19027339,19077143,780442,40171301,19037624,924120,40224159,934262,40180818,1724869,19004718,19076714,19061406,532512,1344143,19080458,1353228,40175309,1742253,905518,40161698,19136210,19018154,40167646,40162116,1301152,1562586,1381504,19028050,1395058,529218,40172287,40168425,933794,19088571,1345858,1177480,1110410,704984,19007701,720810,40226742,1790692,1396012,19014878,1567198,950056,19084670,1758536,1363749,40161044,19038024,40226703,40161726,40171120,1702364,1794280,40175783,991382,933724,923645,1586346,40171218,1504620,1189458,1726228,40170737,40175932,963353,1343916,40170937,40161926,40161577,1135710,1343346,1580747,19030299,904542,40173511,40175864,1766340,1503501,1326115,1114620,1110727,1836430,1521987,19027308,19011064,1384360,1756831,19053746,40169014,19047598,1000772,938268,904525,1114220,744740,40170818,40174213,925636,1140088,529046,928006,1715315,19029550,924296,986417,1307046,718583,1394337,942765,40162079,985247,40175983,528297,19137042,40161960,959362,1150886,19004095,1103137,926487,35602783,922024,40175834,909358,40173209,532424,1373928,40163700,40170235,1118045,712757,40175835,19063981,40161797,19018823,529660,40167554,941258,957393,1309323,1503432,19098548,19030957,984801,19090187,19039679,1325608,19010499,19049105,1319219,958527,1596779,1586449,1703603,1747032,1304643,40162033,950882,40183759,1513849,40170755,40169521,19051513,19098741,40171991,40167549,766337,911735,1704139,1186087,1598658,40166020,923540,1516800,19013986,40170898,980955,1773402,19011035,42801108,992153,19043959,40222465,40226650,1036252,19058572,1397599,19088079,19078092,40175971,1126128,1126557,40162231,42801272,1703069,724394,40161633,1751310,19056300,40222506,1741309,1156378,19078126,915981,1137460,40170964,959665,1792515,1517070,42801306,19082306,1559684,19123754,1714165,40162074,19096710,40171157,1150362,40175871,19020002,1398399,1381253,40162140,1331247,40170402,40172423,19100758,19091149,925952,19045644,908523,19137377,723013,40162144,40170751,1169352,40161242,950435,942028,1352890,990028,1716903,951237,907553,956653,40172876,19050488,40226690,19054702,19039926,923829,1560524,1836948,40161944,19080338,782043,19018483,40161993,1749008,957623,1797155,40161793,740910,19023450,40167658,1728416,523367,964339,1358436,927322,750119,1180182,19003107,19006951,916662,1346823,40167409,940426,19072699,40161593,1125315,1037005,1517740,941577,1344381,955632,19055153,40172774,915841,40223846,40172004,19000537,19136426,19090249,966913,1159811,40175648,40170553,19078968,1500211,19035631,40161642,979096,40161542,40161742,950637,40161344,40161488,40162058,1548195,19044986,19070224,998598,40161849,19022015,529076,743196,1036600,1139216,1336926,948760,19008009,1036059,40170448,1153013,903963,40175460,1387219,40161654,40170814,1325124,1322184,1319133,1118117,40167465,987366,1172206,509079,970011,528301,1107830,532552,40226727,19033354,19080550,912362,19013225,40173188,740924,19092684,1703687,40226736,1769535,40161658,19051865,42799711,1111706,40161781,720727,40170916,40172218,836877,1376289,991003,19015395,19017067,915829,1317640,1303425,19017671,1236607,532518,1797513,991710,1359143,1792429,40170741,1351557,703547,19040233,19088340,1346686,745268,1731597,40170848,40242103,939863,40161688,19017646,939259,941472,705219,19045272,1740546,766067,959174,920064,912476,19091621,19048037,715997,40161972,19050007,905151,40172202,40175746,1558471,1756524,40175669,1394023,40171925,19026343,1326303,40175869,1106776,705944,19056802,939784,1036475,19095744,40161463,1353011,1326012,1036884,739138,19008897,19058867,40172704,1711759,1139993,1389888,937712,19056402,1516766,19058274,19012346,1502855,1747157,1301267,950316,19017585,40172504,1718054,938205,967562,19026450,1183554,40172802,713823,1352141,19021129,902616,1303339,909795,954853,19009874,19049816,40162265,40172997,19084212,794147,40161565,1351541,40224069,19090226,19111620,1768849,19049909,976545,1312706,1180412,19080368,915518,19078187,19045672,703470,1548111,40171223,757688,19030387,19046291,19073699,1707164,1342439,915553,719174,40175995,40171183,787787,1714277,19036731,1503297,927478,529411,1391307,733896,40163670,1386670,19080226,19051035,40224234,1125443,1526475,40173523,40161598,1114122,1560278,735843,1397141,40226753,904639,751412,1702559,1513843,40172644,1000560,19044812,40161930,969276,996416,766209,947416,1786055,19088328,19073031,1734104,40172069,19095309,19037731,1342346,40171783,40163688,19067415,40166035,19090761,792263,786426,19019122,919204,19020994,40161730,19010927,1595799,19037038,595252,1380068,1327256,1115008,19077457,19095802,40224195,1784444,1560171,19076389,1343039,955372,529118,915392,754270,994058,40223116,19080512,528990,1359548,734354,1367571,1756822,904704,1354118,40161637,19095288,937791,836715,40172048,19062195,917336,19090221,957797,1508241,40224992,19049228,40225727,40226681,1304850,19005104,40173720,19037596,1555887,40162070,904453,40162219,1750087,19095002,40222116,19036391,1550557,1315027,1236744,1749301,1352213,1728909,1513103,1000632,40163674,40161684,40171179,19014213,40170979,1714319,40175341,1749083,1727223,940535,947705,1774470,755695,978236,40171362,19047423,751347,40162037,977968,40170911,40174102,19024227,960988,40164828,19060992,40170444,987128,40170576,40161602,709567,1378382,1236493,528271,19047756,19087063,19022003,1345141,1344992,40172600,19031713,19031378,19012543,19006692,1316262,1329415,924939,750982,1592085,19009686,923840,1319156,537647,19043395,40161918,528988,42801285,19082871,40172449,1116031,704053,40163690,941052,1712549,1508439,1784749,1786621,40241606,1001419,1103314,1136487,19032599,951112,1781406,1758392,916802,19092845,922868,1545958,908464,948490,717607,1102527,1141018,749910,19054242,40170592,40174671,19013730,978555,19046454,40162054,40173249,19066774,40161167,1578181,985708,40175808,1738135,19059707,40170341,40173636,992716,19028106,19024723,19037223,40167574,939134,1524674,935390,19003472,1514412,19025693,40161354,923081,1391642,1300751,1368671,919839,40170646,945286,1703026,40163587,1136601,40171977,1729323,529303,19001323,40161890,1363387,40173211,948787,1369939,40170680,19039874,19067073,19017805,1150871,1344905,931973,990499,40175985,790253,1189754,40163694,40170973,529112,1140643,1747005,40162251,962398,1586808,19026459,1710446,1746244,19000732,933952,40171114,1513876,40172688,753626,1036525,748010,1302398,529044,40175760,40225028,1130585,19034726,40172445,981709,44785885,742185,732893,40172084,40161213,19020477,40175794,1757803,1701677,1789517,40167608,40172254,914053,1517824,19005046,40170416,903459,914840,19006586,1777417,40161694,1525278,1733765,40161809,40172858,40171135,40172492,529180,19006186,738156,40161077,19044337,40167025,1366310,948515,19051642,1395773,958994,19137312,40226521,1717704,801396,1110942,1343914,928744,943116,1189490,529214,40161260,1332418,19009896,1341927,19067303,19087223,19095043,40172722,986517,19090180,974166,1350066,19024770,1551099,40161192,909841,1525746,743670,19032407,40227355,19013721,40172539,40161558,1584910,1588986,903893,1708880,981654,1391846,19061083,40175951,1353776,40162128,1154343,40170335,934075,733523,40171271,1701928,19050123,40175917,1716721,1547504,924566,40174011,1188052,40175734,40161124,1113648,19050387,986117,1361711,1136980,926770,733008,1518148,1713905,1753745,19011773,40238145,19093848,40168421,40172798,1139179,1338005,1711947,1701651,40172466,1503057,19003953,724908,1558242,1742432,40166881,1789428,19010955,40170408,1597235,993979,40161801,19036909,1590165,40162170,729855,1555120,949459,702865,19052936,40169140,767410,19023842,1314273,40175841,19035223,40171093,40170458,532584,19005208,40226696,19072255,908730,40175959,1775741,992308,735340,1760616,43012263,1552929,958134,19068715,40172147,19002664,1114375,532430,19137385,19136750,40171297,532516,1340128,40162120,19024728,1112921,19049877,40170876,1717963,19005658,1366773,1237049,40163672,40176004,1301025,1301125,939726,40171953,1712889,40169509,19057346,40161228,1512480,1717240,1311078,40161714,900093,19018013,40170774,902251,19092849,1139042,40170588,40172160,40168316,905223,1309799,1385800,908360,1337107,949279,961304,19031224,40168516,915855,1103374,40172453,19006874,40175911,19027080,1350504,529713,19089891,1754994,956874,40162200,40161914,730729,992956,1349025,40182120,19050644,928980,40172153,19057932,19073229,40168423,40224997,965748,1154332,927194,40163686,1380191,715939,40172846,40173046,976778,987406,19048999,700465,963742,40170322,19041843,40175938,19009148,731188,40161537,40170808,40167582,925102,1305496,1197736,969444,40161030,19079204,1164108,1501700,1512446,1332661,19058291,19024663,40172730,996541,40175870,19069873,19052489,1389885,989482,1836241,19061088,1703063,40226492,1707800,40170858,40162259,1790024,19046180,19026710,40161048,712615,19087317,1518198,942350,1337720,1503983,19036781,40171969,908126,932815,19010309,1356461,19005629,40162005,1344965,1137529,1399177,1511646,40175802,40163702,1126658,977421,950792,1736887,40170722,40173198,40172594,703244,40224095,40173773,19117912,19092290,735850,1314924,40225031,930747,901318,1759455,40162112,785649,766814,1196677,1301065,40172806,40176150,40170385,40222427,40170834,19000818,40163684,19097867,1378509,837027,1729720,19009057,19058978,40176165,1759270,40223799,19050554,1543229,1316354,1515249,40172372,1307515,40161861,922976,19037401,1140640,1309204,908921,756018,40226707,702774,19021959,40161676,19070174,789578,1351935,40228445,1321636,40172908,40161976,40172055,40168262,19007572,40175899,40161040,781039,40175865,19089579,40222408,40161610,1300978,40161710,946340,19080336,40163731,19026739,19086622,929128,730548,914335,523365,1178663,19022446,40176152,1140123,1309068,721724,1750461,906149,1326901,1154029,836208,1331681,1308432,19136716,1351779,745466,1391470,750146,40162204,1523280,40167333,40170628,40164826,713192,40161082,989301,40161182,1529331,794852,19013765,1353766,1537655,40226715,958999,19078156,1586369,40163676,40161718,40162104,19008264,19029306,40175807,1778162,911486,938044,1778262,708298,19024775,1036094,19082886,40161968,1502809,1123534,40161853,40161467,40226579,1552310,40226665,19135830,916751,19009250,19030692,40167083,40161953,40222500,1551860,40222285,40176157,19060393,1738521,980478,40161553,1195334,532582,1736999,1315411,40172900,19058971,944360,914244,40161817,40172299,40161754,1436776,1304565,993631,19080514,19050087,1151422,40223294,1140590,902938,40163615,939506,19060400,1385645,19026274,40165636,1760039,1147878,19091701,724816,529216,19044522,1106647,921956,40175898,19010128,1338985,1308216,40161692,19022479,1510202,529114,40226438,19067803,19087208,42800226,930916,40160943,942799,40170452,40162062,40227472,1153928,1705674,987153,1797258,905078,1310756,40161896,1154077,1138050,1762711,961047,19002257,40161845,19018416,1389036,916059,797399,19090229,40161662,40169482,919986,1149380,1501617,1787101,19054821,19078219,997276,942494,1594973,1326378,40227488,1782521,1525215,19006855,1338512,1743222,782211,951511,702661,40163712,977949,722424,40172100,1348265,943030,40172000,705103,40172670,40161738,40170557,987009,40163710,929983,19091430,904356,40226409,40172636,19025348,40170521,19097605,1736829,1786842,43012718,981691,929549,1119510,1189697,40227386,19060837,501343,967823,40224678,19052447,967496,40224137,19096546,956691,1101898,1398937,40172534,40171598,990760,700253,42800027,40161940,954819,40162097,1181809,40161997,40172270,1152134,1750074,40163718,40161989,40170356,1736971,19013951,1759842,40175872,950183,725131,1351115,40161746,528323,1355509,19015523,19077884,40169420,950933,40163704,1702911,19014158,40160939,1305637,40172335,1310317,1549080,40223750,40227394,1724703,951469,40161203,19035100,711584,1741122,40161589,40161446,40161532,1789515,40163668,1308738,1563413,1799139,1525866,714785,766529,35606323,974140,19019131,731533,19042345,978577,40170549,929698,778268,40161103,19002912,942659,1755112,19012565,40170656,40170699,19089602,40161482,911064,1709170,1309188,1153428,1560305,19015230,1336539,1519936,986515,40176129,953391,19092224,19092167,1315286,40222461,40172640,739323,535714,1163570,1309770,40162078,1800835,40162029,40162178,40162227,1353256,1134439,1154161,40175984,922191,19063575,40171787,19087090,791967,40175833,40175933,19066919,1129625,943634,40171087,19026707,40175884,1521369,1536743,19086790,1554072,903643,715259,1329241,1151789,800878,745790,1363516,40175931,936748,990413,742267,532272,40170366,909440,902722,1397059,1583722,40170466,1149196,1103640,40226656,19058410,40164052,19016747,1436650,1115572,948078,1711523,1307247,909959,940541,954696,19018419,40170868,42801112,715710,1557272,19030860,966991,1308842,1322081,42800417,1105889,40175889,1318137,40175775,1342001,1711246,596876,904501,1780601,1396131,43013616,42801254,40226747,1368823,917205,19017742,911354,990069,991706,1740226,19059654,1350489,1524769,40162136,40171110,40168938,940183,19081667,938362,1763204,923672,19006410,713196,1152631,1370109,1106740,749727,40224189,1595461,1386957,1790812,514015,998394,40163708,958368,727835,40167352,1350040,19069149,1763339,19016670,40172396,40181642,937725,951980,40170759,963747,19000729,966956,40227484,42800082,40174268,40175840,19011440,40161785,777221,40161150,1389780,1351461,40162152,905371,19052317,1549254,40172580,40174252,705755,19003303,920293,19101422,19090204,1112807,40172566,40163692,939881,1327978,949759,1738170,980311,19011456,950696,40169389,530007,1544838,1724666,19100985,19033634,40227400,1318853,1335301,19006043,948555,40167317,40161334,40161569,40162087,1521592,1745072,911638,1309161,40170929,19013477,901845,703083,948487,40168385,40170375,45775689,40174405,778474,1337620,571187,40175842,40172112,19060877,787362,1506602,1436678,991876,915935,529072,19049410,40171580,903031,1347384,1314577,1317967,1549786,40168303,1588712,929504,19039850,1315946,19008366,1507705,40173533,1511449,929435,1185922,19052903,991825,40162020,40165678,1383815,1163944,1123904,44784806,40161734,1790868,40176021,19039029,40168899,532488,1502905,19025925,529042,940004,1522957,19021488,19092139,40164866,19009022,997496,19096487,19071160,1133732,929542,1786617,586491,1400498,19081320,40172584,906780,1345205,40166461,40167729,1036157,19035953,40163696,19059528,759401,40167231,1746114,1379969,1837289,1636780,19009847,40174124,757627,738818,1321341,1116109,1551803,1717327,1703653,40175719,1363053,986864,40172384,794229,529212,40161624,40161922,902427,40227438,975125,1189220,40162083,1586640,40161722,952538,1781733,19026972,1036425,931035,924151,19082111,19057354,1512674,40167733,19053610,40161390,709699,19092373,1101703,723344,19045045,1330974,1734205,1777087,19136429,19050461,40161680,1708100,1344354,1539954,19069019,924309,40170840,1796458,1367500,1326481,19010459,1300673,1124300,19087067,992590,1319193,1394333,46221581,19005061,1721543,1315942,966468,40225038,769935,19062817,40173205,40175970,40169661,701322,1714527,1738366,45892906,528986,1314002,19127890,40162148,19025274,1337159,939871,40222391,19076414,920458,1836391,940864,40224770,1118084,1836191,961145,19049024,1363981,40160955,42898673,19009405,1309944,40162066,40175863,1777806,40166571,735979,19070012,1746940,1101554,1399063,42903728,1516976,19061124,40161573,1146810,19031583,1398677,19080274,1174888,1351447,1796435,955252,19010482,19023286,1710281,998415,40172317,1314865,40170531,984232,1360421,916005,40161964,939976,711452,40162050,1304919,40161171,1105775,1373225,40167666,19035704,1168079,19010961,40171124,40172710,1313200,19003959,1502877,958396,40224861,716968,704943,1315865,1520218,19013926,19036797,19063605,40175868,1750500,1727443,1768734,980867,785788,40170438,40161750,40172610,702685,1636145,1704758,42799803,981774,1312007,40175261,1310149,1362979,1335471,1102917,40161064,986790,1150345,905273,1354698,1748921,1307863,40175754,959196,1318030,1713332,19086176,40172010,19038562,19005452,913440,1139699,40222289,1525741,40162243,1366237,40161857,40171317,19010868,19095164,914533,735951,704599,937439,40175912,19089992,40161906,40163678,1531601,1319751,19009540,915175,40224210,1304277,1335606,40161706,40225012,19023835,40167522,40172838,40170396,1596977,19027958,19035569,1836410,1507835,19019800,40224712,912803,19078151,19036946,40161629,1333357,40161606,1597756,902950,956266,1344996,798834,913782,991855,976309,795113,1377141,42800238,19044727,40222440,922570,40162208,1724827,1307026,40162108,1186385,19016749,732309,40222431,757352,1319051,19004724,1366279,1598819,1506270,705178,523212,1305447,19060903,19013782,19027181,40163680,19011712,40171961,1836503,1350310,19052817,1331270,40169074,932745,920113,40172632,19095786,40162235,954688,906874,1789276,951279,1398039,40174604,19026180,986261,713109,19057718,19038998,1145379,19092377,1589795,19039298,40170360,932196,910232,19080982,1390051,19029824,733301,40161386,40161349,1300153,40170660,1338558,19017241,938061,40172246,19095721,40174018,1724700,40171995,40174004,40176125,1530014,1437379,1111220,943191,40170509,1188114,40175939,40226762,1105853,918906,970250,744798,719311,19072857,40173567,40167516,19025194,1167322,1707687,19068964,988447,19027015,40175625,920378,929887,929638,19091377,42801267) 
				    AND drug_concept_id NOT IN (914533) 
	         ) T1
	   WHERE one_row_per_person_and_drug_row_number = 1
	) T2
WHERE one_row_per_person_row_number = 1;

---------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------

/* COHORT 41. POPULATE TABLE WITH COMPARATOR DRUG COHORT BASED ON FIRST TIME USE (FOR DESCRIPTIVE ANALYSES) */
-- Cohort constructed using COHORT 4 (pool of eligible comparator drug eras) as study base 
-- Risk time starts at drug_era_start_date (i.e. index date)
-- Risk time ends at drug_era_start_date+30 days or last date of observation (includes death) whichever occurs first 
-- Note: no need to define censoring based on drug_era_end_date as max time at risk is 30 days
INSERT INTO OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original (
  cohort_definition_id,
  cohort_start_date,
  cohort_end_date,
  subject_id,
  drug_concept_id,
  observation_period_end_date,
  death_date,
  order_number)
SELECT 41 AS cohort_definition_id, 
       t.drug_era_start_date AS cohort_start_date,							-- set cohort start date (index date) as drug era start date
       CASE WHEN t.observation_period_end_date <= DATEADD(DAY, +30, t.drug_era_start_date)	-- set cohort end date as last date of obs or drug era start date +30 days whichever occurs first
	        THEN t.observation_period_end_date 
			ELSE DATEADD(DAY, +30, t.drug_era_start_date)  
			END AS cohort_end_date,
       t.subject_id,
       t.drug_concept_id,
       t.observation_period_end_date,
       t.death_date,
       t.order_number
FROM ( SELECT subject_id,											
              drug_concept_id,
              drug_era_start_date,
              observation_period_end_date,
              death_date,
              ROW_NUMBER() OVER ( PARTITION BY subject_id         -- select first-time use of target drug only (i.e. first drug era)
                                  ORDER by drug_era_start_date 
                                ) AS order_number 
       FROM OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original
       WHERE cohort_definition_id = 4 ) t 
WHERE t.order_number = 1;

/* Check no. of obs in table COHORT 41 (96780) */ -- not needed in final script, used for data check only
--SELECT COUNT(*) FROM OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original  WHERE cohort_definition_id = 41;
--SELECT * FROM OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original  WHERE cohort_definition_id = 41;

---------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------

/* COHORT 40. POPULATE TABLE WITH COMPAROTOR DRUG COHORT BASED ON FIRST TIME USE (FOR CHRONOGRAPH ANALYSES) */
-- Risk time starts at drug_era_start_date-3 yrs or earliest date of observation whichever occurs last
-- Risk time ends at drug_era_start_date+3 yrs, drug era end date or last date of observation (includes death) whichever occurs first 
-- Note: need to set persistence gap for drug eras (default is ?)
INSERT INTO OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original (
  cohort_definition_id,
  cohort_start_date,
  cohort_end_date,
  subject_id,
  drug_concept_id,
  drug_era_start_date,
  drug_era_end_date,
  observation_period_start_date,
  observation_period_end_date,
  death_date,
  order_number)
SELECT 40 AS cohort_definition_id, 
       t.drug_era_start_date AS cohort_start_date,
	   t.drug_era_end_date AS cohort_end_date,
	   t.subject_id,
	   t.drug_concept_id,
	   t.drug_era_start_date,
	   t.drug_era_end_date,
	   t.observation_period_start_date,
	   t.observation_period_end_date,
	   t.death_date,
	   t.order_number
FROM ( SELECT subject_id,
	   	      drug_concept_id,
	   	      drug_era_start_date,
	   	      drug_era_end_date,
	   	      observation_period_end_date,
	   	      observation_period_start_date,
	   	      death_date,
	   	      ROW_NUMBER() OVER ( PARTITION BY subject_id			-- select first-time use of target drug only (i.e. first drug era)
  	   	      	   	              ORDER by drug_era_start_date
                                ) AS order_number 
       FROM OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original
       WHERE cohort_definition_id = 4) t 
WHERE t.order_number = 1;

---------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------

/* COHORT 42. POPULATE TABLE WITH TOTAL DRUG (TARGET AND COMPARATOR) COHORT BASED ON FIRST TIME USE (FOR CHRONOGRAPH ANALYSES) */
/* Defined as all subjects in cohort 22 and cohort 40 */
INSERT INTO OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original (
  cohort_definition_id,
  cohort_start_date,
  cohort_end_date,
  subject_id,
  drug_concept_id,
  drug_era_start_date,
  drug_era_end_date,
  observation_period_start_date,
  observation_period_end_date,
  death_date,
  order_number)
SELECT 42 AS cohort_definition_id,
       cohort_start_date,
       cohort_end_date,
       subject_id,
       drug_concept_id,
       drug_era_start_date,
       drug_era_end_date,
       observation_period_start_date,
       observation_period_end_date,
       death_date,
       order_number
FROM OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original 
WHERE cohort_definition_id IN (22,40);

---------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------

/* COHORT 3*. POPULATE TABLE WITH COHORT OF ELIGIBLE CONDITION ERAS (STUDY POOL)*/
-- Study pool for extracing conditions for merging with target, comparator, total (target and comparator) drug cohorts 
-- NOTE: includes distinct, 
INSERT INTO OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original (
  cohort_definition_id,
  cohort_start_date,
  cohort_end_date,
  subject_id
)
SELECT 3 AS cohort_definition_id,												 
       x.cohort_start_date,                                    -- outcome @event_start_date, for use in  chronograph 
       x.cohort_end_date,
       x.subject_id
FROM ( SELECT DISTINCT condition_era_start_date AS cohort_start_date,			-- distinct to select only 1 record per day (multiple diagnoses on the same day most likely refer to the same occurrence than seperate occurrences)
                       condition_era_end_date AS cohort_end_date,                         -- set cohort start date as condition era start date (used in analysis) and cohort end date as condition era start date (not used in analysis)
                       person_id AS subject_id
       FROM OmopCdm.synpuf5pct_20180710.condition_era
       WHERE condition_concept_id IN ( SELECT descendant_concept_id
							  		   FROM OmopCdm.synpuf5pct_20180710.concept_ancestor
									   WHERE ancestor_concept_id IN (37125009) ) 
	  ) x;

---------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------

/* COHORT 11. POPULATE TABLE WITH TARGET DRUG COHORT BASED ON FIRST TIME USE WITH EVENT IN 30-DAY POST INDEX RISK WINDOW (FOR DESCRIPTIVE ANALYSES) */
-- Cohort constructed from COHORT 21 (target drug cohort) and COHORT 3 (pool of eligible condition eras) as study base 
-- Includes first post-index date diagnosis only (only 1 event per subjectid).

INSERT INTO OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original (
  cohort_definition_id, 
  cohort_start_date, 
  cohort_end_date, 
  subject_id)
SELECT 11 AS cohort_definition_id,
       t.t21cohort_start_date AS cohort_start_date,             -- set cohort start date (index date) as drug era start date (cohort start date from target drug cohort (21))
	   CASE WHEN t.t3cohort_start_date <= t.t21cohort_end_date 
	        THEN t.t3cohort_start_date     -- set cohort end date as condition era start date (cohort start date from event cohort (3)), date of last obs or drug era start date +30 days (cohort end date from target drug cohort (21)) whichever occurs first
	        ELSE t.t21cohort_end_date 
			END AS cohort_end_date,
	   t.t21subject_id AS subject_id
FROM ( SELECT t11.*,
              row_number() over(PARTITION BY t11.t3subject_id ORDER BY t11.t3cohort_start_date) AS ROW
       FROM ( SELECT t3.cohort_definition_id AS t3cohort_definition_id,
                     t3.cohort_start_date AS t3cohort_start_date,
                     t3.cohort_end_date AS t3cohort_end_date,
                     t3.subject_id AS t3subject_id,
                     t21.cohort_definition_id AS t21cohort_definition_id,
                     t21.cohort_start_date AS t21cohort_start_date,
                     t21.cohort_end_date AS t21cohort_end_date,
                     t21.subject_id AS t21subject_id
              FROM OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original t3
              INNER JOIN OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original t21 ON t3.subject_id = t21.subject_id
              WHERE t3.cohort_definition_id = 3
                    AND t21.cohort_definition_id = 21
                    AND t3.cohort_start_date BETWEEN t21.cohort_start_date AND t21.cohort_end_date 
            ) t11
     ) t
WHERE t.row=1;
---------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------

/* COHORT 31. POPULATE TABLE WITH COMPARATOR DRUG COHORT BASED ON FIRST TIME USE WITH EVENT IN 30-DAY POST INDEX RISK WINDOW (FOR DESCRIPTIVE ANALYSES) */
-- Cohort constructed from COHORT 41 (target drug cohort) and COHORT 3 (pool of eligible condition eras) as study base 
-- Includes first post-index date diagnosis only (only 1 event per subjectid).

INSERT INTO OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original (
  cohort_definition_id, 
  cohort_start_date, 
  cohort_end_date, 
  subject_id)
SELECT 31 AS cohort_definition_id,
       t.t41cohort_start_date AS cohort_start_date,   -- set cohort start date (index date) as drug era start date (cohort start date from comparator drug cohort (41))
	   CASE WHEN t.t3cohort_start_date <= t.t41cohort_end_date 
	        THEN t.t3cohort_start_date     -- set cohort end date as condition era start date (cohort start date from event cohort (3)), date of last obs or drug era start date +30 days (cohort end date from target drug cohort (41)) whichever occurs first
	        ELSE t.t41cohort_end_date 
			END AS cohort_end_date,
	   t.t3subject_id AS subject_id
FROM ( SELECT t31.*,
              row_number() over(PARTITION BY t31.t3subject_id ORDER BY t31.t3cohort_start_date) AS ROW
       FROM ( SELECT t3.cohort_definition_id AS t3cohort_definition_id,
                     t3.cohort_start_date AS t3cohort_start_date,
                     t3.cohort_end_date AS t3cohort_end_date,
                     t3.subject_id AS t3subject_id,
                     t41.cohort_definition_id AS t41cohort_definition_id,
                     t41.cohort_start_date AS t41cohort_start_date,
                     t41.cohort_end_date AS t41cohort_end_date,
                     t41.subject_id AS t41subject_id
              FROM OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original t3
              INNER JOIN OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original t41 ON t3.subject_id = t41.subject_id
              WHERE t3.cohort_definition_id = 3
                    AND t41.cohort_definition_id = 41
                    AND (t3.cohort_start_date BETWEEN t41.cohort_start_date AND t41.cohort_end_date) 
            ) t31
     ) t
WHERE t.row=1;
---------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------

/* COHORT 32. POPULATE TABLE WITH TOTAL (TARGET AND COMPARATOR) DRUG COHORT BASED ON FIRST TIME USE WITH EVENT(S) IN 3-YR PRE OR 3-YR POST INDEX RISK WINDOW (FOR TEMPORAL ANALYSES) */
-- Cohort constructed using COHORT 42 (total (target and comparator) drug cohort) and 3 (pool of eligible condition eras) as study base 
-- Includes any event diagnosis in the risk window before or after the index date (allows more than 1 event per subjectid)

INSERT INTO OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original (
  cohort_definition_id, 
  cohort_start_date, 
  cohort_end_date, 
  subject_id)
SELECT 32 AS cohort_definition_id,
       t.t3cohort_start_date AS cohort_start_date,                                         -- set cohort start date (index date) as drug era start date -3 yrs or first date of obs whichever occurs last from total drug cohort (42)
       t.t3cohort_end_date  AS cohort_end_date,
       t.t3subject_id AS subject_id
FROM ( SELECT t3.cohort_definition_id AS t3cohort_definition_id,
              t3.cohort_start_date AS t3cohort_start_date,
              t3.cohort_end_date AS t3cohort_end_date,
              t3.subject_id AS t3subject_id
       FROM OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original t3
       WHERE t3.cohort_definition_id = 3
	  ) t;

---------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------

-- Initiate the table that will hold the final sampled cohorts
IF OBJECT_ID('OmopCdm.synpuf5pct_20180710.cohorts_Sarahe', 'U') IS NOT NULL 
DROP TABLE OmopCdm.synpuf5pct_20180710.cohorts_Sarahe;
CREATE TABLE OmopCdm.synpuf5pct_20180710.cohorts_Sarahe (
  cohort_definition_id INT,
  cohort_start_date DATE,
  cohort_end_date DATE,
  subject_id BIGINT)

-- Apply any other sampling on the original-table to create the final one
INSERT INTO OmopCdm.synpuf5pct_20180710.cohorts_Sarahe(
    cohort_definition_id,
    cohort_start_date,
    cohort_end_date,
    subject_id
  )
SELECT cohort_definition_id, cohort_start_date, cohort_end_date, subject_id
FROM ( SELECT cohort_definition_id, cohort_start_date, cohort_end_date, subject_id, maximum_cohort_size_row_number
	   FROM (SELECT *, Row_number() OVER(PARTITION BY cohort_definition_id ORDER BY newid()) AS maximum_cohort_size_row_number
             FROM OmopCdm.synpuf5pct_20180710.cohorts_Sarahe_original) T1
       WHERE cohort_definition_id in (22, 32, 42) OR maximum_cohort_size_row_number <= 500 -- restrict to cohort sample size for descriptive-tables cohorts
	   ) T2
WHERE cohort_definition_id IN (11, 21, 22, 31, 32, 41, 42)


